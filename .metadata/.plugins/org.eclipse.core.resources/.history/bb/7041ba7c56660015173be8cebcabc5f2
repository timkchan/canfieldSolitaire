package canfield;

import ucb.gui.TopLevel;
import ucb.gui.LayoutSpec;

import java.awt.event.MouseEvent;

/** A top-level GUI for Canfield solitaire.
 *  @author Tim Chan
 */
class CanfieldGUI extends TopLevel {

    /** A new window with given TITLE and displaying GAME. */
    CanfieldGUI(String title, Game game) {
        super(title, true);
        _game = game;
        
        addMenuButton("Data->Undo", "undo");
        addMenuButton("Data->Restart", "restart");
        addMenuButton("Data->Quit", "quit");
        
        addMenuButton("View->Change Deck Colour", "changeDeck");
        
        /*
        addLabel("Sorry, no graphical interface yet",
                 new LayoutSpec("y", 0, "x", 0));
        addButton("Quit", "quit", new LayoutSpec("y", 0, "x", 1));
        */

        _display = new GameDisplay(game);
        add(_display, new LayoutSpec("y", 2, "width", 2));
        _display.setMouseHandler("click", this, "mouseClicked");
        _display.setMouseHandler("release", this, "mouseReleased");
        _display.setMouseHandler("drag", this, "mouseDragged");

        display(true);
    }

    /** Response to "Quit" menu item.. */
    public void quit(String dummy) {
        if (showOptions("Really quit?", "Quit?", "question",
                        "Yes", "Yes", "No") == 0) {
            System.exit(1);
        }
    }
    
    /** Response to "changeDeck" menu item.. */
    public void changeDeck(String dummy) {
        _display.setColour();
        _display.repaint();
    }
    
    /** Response to "Undo" menu item.. */
    public void undo(String dummy) {
        _game.undo();
        _display.repaint();
    }

    /** Response to "restart" menu item.. */
    public void restart(String dummy) {
        //To-do
    }
    
    /** Return True if the cursor is on a card at loc_x, loc_y */
    public boolean onCard(int cursor_x, int cursor_y, int loc_x, int loc_y) {
        return (loc_x <= cursor_x && cursor_x <= loc_x + 90)
                && (loc_y <= cursor_y && cursor_y <= loc_y + 125);
    }
    
    /** Return True if the cursor is on Stock */
    public boolean onStock(int cursor_x, int cursor_y) {
        return onCard(cursor_x, cursor_y, _display.S_X, _display.S_Y);
    }
    
    /** Return True if the cursor is on Reserve */
    public boolean onReserve(int cursor_x, int cursor_y) {
        return onCard(cursor_x, cursor_y, _display.R_X, _display.R_Y);
    }
    
    /** Return True if the cursor is on Waste */
    public boolean onWaste(int cursor_x, int cursor_y) {
        return onCard(cursor_x, cursor_y, _display.W_X, _display.W_Y);
    }
    
    /** Return True if the cursor is on any Foundation */
    public boolean onFoundation(int cursor_x, int cursor_y) {
        return onCard(cursor_x, cursor_y, _display.F1_X, _display.F1_Y)
                || onCard(cursor_x, cursor_y, _display.F2_X, _display.F2_Y)
                || onCard(cursor_x, cursor_y, _display.F3_X, _display.F3_Y)
                || onCard(cursor_x, cursor_y, _display.F4_X, _display.F4_Y);
    }
    
    /** Action in response to mouse-clicking event EVENT. */
    public synchronized void mouseClicked(MouseEvent event) {
        
        if (onStock(event.getX(), event.getY())) {
            _game.stockToWaste(); 
        }
        
        _display.repaint();
    }
 
    /* Location where mouse is clicked. */
    int pressed_x = 0, pressed_y = 0;
    
    /** Called when the mouse has been pressed. */
    public synchronized void mousePressed (MouseEvent event) {
        pressed_x = event.getX();
        pressed_y = event.getY();
    }
    
    /** Action in response to mouse-released event EVENT. */
    public synchronized void mouseReleased(MouseEvent event) {
        // FIXME
        if (onReserve(pressed_x, pressed_y)
                && onFoundation(event.getX(), event.getY())) {
            _game.reserveToFoundation();
        }
        
        _display.repaint();
    }

    /** Action in response to mouse-dragging event EVENT. */
    public synchronized void mouseDragged(MouseEvent event) {
        // FIXME
        if (onReserve(pressed_x, pressed_y)
                && onFoundation(event.getX(), event.getY())) {
            _game.reserveToFoundation();
        }
        
        if (onReserve(pressed_x, pressed_y)
                && onFoundation(event.getX(), event.getY())) {
            _game.reserveToFoundation();
        }
        _display.repaint();  // Not needed if picture does not change.
    }

    /** The board widget. */
    private final GameDisplay _display;

    /** The game I am consulting. */
    private final Game _game;

}
